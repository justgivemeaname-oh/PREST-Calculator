<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PREST (Predictive Response Evaluation of Steroid in TED) calculator</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.css">
<style>
  :root{
    --bg:#f7f8fb;
    --card:#ffffff;
    --ink:#1b1f24;
    --muted:#606a78;
    --accent:#2f6fed;
    --accent-2:#12b886;
    --border:#e5e8ef;
    --shadow: 0 8px 24px rgba(10, 22, 70, 0.08);
    --radius:16px;
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  body{margin:0;background:var(--bg);color:var(--ink);}

  .wrap{ max-width: 980px; margin: 48px auto; padding: 0 16px; }
  .frame{ background:var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
  .title-frame{ padding: 24px 28px; margin-bottom:18px; border-left:5px solid var(--accent);}
  .title-frame h1{ margin:0; font-size: 22px; font-weight: 700; letter-spacing:.2px; }
  .subtitle{margin-top:6px; color:var(--muted); font-size:14px;}

  .panel{ padding: 22px 24px; }
  .panel h2{ margin-top:0; margin-bottom:14px; font-size:16px; font-weight:700; color:var(--accent); }

  .row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 0;
    border-top:1px dashed var(--border);
  }
  .row:first-of-type{border-top:0;}
  .label{ flex:1 1 360px; font-weight:600; line-height:1.35; }
  .hint{ color:var(--muted); font-weight:500; font-size:13px; margin-top:4px; }

  .toggle{ display:inline-flex; border:1px solid var(--border); border-radius: 999px; overflow:hidden; background:#f9fafc; }
  .toggle button{ appearance:none; border:0; padding:10px 18px; cursor:pointer; font-weight:600; color:var(--muted); background:transparent; }
  .toggle button.active.yes{background:var(--accent); color:#fff;}
  .toggle button.active.no{background:#e9eefc; color:#2948c2;}
  .toggle button:focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius: 999px;}

  .score-box{ display:flex; align-items:center; gap:14px; padding:14px 16px; background:#f5f8ff; border:1px solid #dfe7ff; border-radius:12px; }
  .score-num{ font-size:28px; font-weight:800; color:#2948c2; min-width:64px; text-align:center; border-radius:12px; background:#fff; border:1px solid var(--border); padding:8px 12px; }
  .btn-primary{ appearance:none; border:0; border-radius: 12px; background:var(--accent); color:#fff; padding:12px 18px; font-weight:700; cursor:pointer; box-shadow: var(--shadow); }
  .btn-primary:hover{filter:brightness(1.02);}
  .btn-primary:active{transform:translateY(1px);}

  /* Risk + probability */
  .risk-prob-grid{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:12px;
  }
  .risk-card, .prob-card{
    flex:1 1 260px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f9fafc;
    padding:12px 14px;
  }
  .card-title{
    font-size:13px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:var(--muted);
    margin-bottom:6px;
  }
  .risk-pill{
    display:inline-flex;
    align-items:center;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    margin-bottom:6px;
  }
  .risk-pill.low{
    background:rgba(18,184,134,0.08);
    color:#087f5b;
  }
  .risk-pill.intermediate{
    background:rgba(255,176,0,0.12);
    color:#ad6800;
  }
  .risk-pill.high{
    background:rgba(230,82,82,0.12);
    color:#c92a2a;
  }
  .risk-points{
    font-size:13px;
    color:var(--ink);
    margin:0;
    padding-left:16px;
  }
  .risk-points li{ margin-bottom:2px; }

  .prob-value{
    font-size:20px;
    font-weight:700;
    color:#1b1f24;
    margin-bottom:4px;
  }
  .prob-caption{
    font-size:11px;
    color:var(--muted);
    line-height:1.5;
  }

  table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
  thead th{background:#f1f4fb; color:#24324a; font-size:13px; letter-spacing:.2px; text-transform:uppercase;}
  th, td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:right;}
  th:first-child, td:first-child{text-align:left;}
  tbody tr:hover{background:#fafbff;}

  .chart-wrap{
    padding:0;
    border:1px dashed var(--border);
    border-radius:12px;
    background:#fff;
    margin:0;
  }
  canvas{width:100%; height:360px; display:block;}

  .note{color:var(--muted); font-size:12px; line-height:1.5;}

  /* chart row 밀착 */
  #output .row.chart-row{
    padding-top:0;
    padding-bottom:0;
    border-top:0;
  }
</style>
</head>
<body>
  <div class="wrap frame">

    <!-- Title frame -->
    <div class="title-frame">
      <h1>PREST (Predictive Response Evaluation of Steroid in TED) calculator</h1>
      <div class="subtitle">Scoring derived from stepwise backward logistic regression on TED cohort.</div>
    </div>

    <!-- Input frame -->
    <div class="panel">
      <h2>Medical history and laboratory data</h2>

      <!-- Row: TSHRab -->
      <div class="row">
        <div class="label">
          TSH receptor antibody (TSHRab)
          <div class="hint">Threshold: <strong>≥ 4.59 IU/L</strong></div>
        </div>
        <div class="toggle" data-field="TSHRab">
          <button class="no"   type="button">No ( &lt; 4.59 )</button>
          <button class="yes"  type="button">Yes ( ≥ 4.59 )</button>
        </div>
      </div>

      <!-- Row: TSI -->
      <div class="row">
        <div class="label">
          Thyroid Stimulating Immunoglobulin (TSI)
          <div class="hint">Threshold: <strong>≥ 406 SRR%</strong></div>
        </div>
        <div class="toggle" data-field="TSI">
          <button class="no"   type="button">No ( &lt; 406 )</button>
          <button class="yes"  type="button">Yes ( ≥ 406 )</button>
        </div>
      </div>

      <!-- Row: CAS -->
      <div class="row">
        <div class="label">
          Clinical Activity Score (CAS)
          <div class="hint">Threshold: <strong>≥ 4</strong></div>
        </div>
        <div class="toggle" data-field="CAS">
          <button class="no"   type="button">No ( &lt; 4 )</button>
          <button class="yes"  type="button">Yes ( ≥ 4 )</button>
        </div>
      </div>

      <!-- Row: Exophthalmos -->
      <div class="row">
        <div class="label">
          Exophthalmos (largest Hertel)
          <div class="hint">Threshold: <strong>≥ 19 mm</strong></div>
        </div>
        <div class="toggle" data-field="EXO">
          <button class="no"   type="button">No ( &lt; 19 mm )</button>
          <button class="yes"  type="button">Yes ( ≥ 19 mm )</button>
        </div>
      </div>

      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <button id="calcBtn" class="btn-primary" type="button">Calculate PREST</button>
        <div class="score-box" aria-live="polite" aria-atomic="true">
          <div class="score-num" id="prestScore">0</div>
          <div>
            <div style="font-weight:700;">PREST score (points)</div>
            <div class="note">PREST = 3·TSHRab + 1·TSI + 2·CAS + 2·Exophthalmos (binary components).</div>
          </div>
        </div>
      </div>

      <!-- Risk + probability -->
      <div class="risk-prob-grid">
        <div class="risk-card">
          <div class="card-title">Risk stratification</div>
          <div id="riskPill" class="risk-pill low">Low risk (PREST 0–4)</div>
          <ul id="riskDetails" class="risk-points">
            <li>Non-response rate: &lt;10%</li>
            <li>Standard IVMP protocol</li>
            <li>Routine monitoring</li>
          </ul>
        </div>

        <div class="prob-card">
          <div class="card-title">Calibrated probability of non-response</div>
          <div id="nonRespProb" class="prob-value">0.0%</div>
          <div class="prob-caption">
            Probability (non-response) = 1 / (1 + exp( −(−2.86 + 0.51 × PREST_Score) ))
          </div>
        </div>
      </div>
    </div>

    <!-- Output frame -->
    <div class="panel" id="output">
      <h2>PREST score</h2>

      <!-- 1) Chart -->
      <div class="row chart-row" style="flex-direction:column;">
        <div class="chart-wrap">
          <canvas id="chart" width="900" height="360" aria-label="Score-responsiveness chart"></canvas>
        </div>
      </div>

      <!-- 2) OR description -->
      <div class="row" style="align-items:flex-start;">
        <div class="label">
          Odds ratios of steroid responsiveness by PREST group<br/>
          <span class="hint">Each odds ratio is relative to the <strong>0-point</strong> group (Haldane–Anscombe 0.5 correction applied, because the 0-point group had 100% response).</span>
        </div>
      </div>

      <!-- 3) OR table -->
      <div class="row">
        <div style="width:100%; overflow-x:auto;">
          <table id="orTable">
            <thead>
              <tr>
                <th>Score</th>
                <th>n</th>
                <th>Responders</th>
                <th>Non-responders</th>
                <th>Responsiveness (%)</th>
                <th>OR vs 0</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="note" style="margin-top:8px;">
            Note: ORs and responsiveness are cohort-derived (n=89). Use as guidance; validate externally before clinical deployment.
          </div>
        </div>
      </div>
    </div>

  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // === Model constants (from your cohort) ===
  const WEIGHTS = { TSHRab: 3, TSI: 1, CAS: 2, EXO: 2 };

  // Observed cohort distribution (n=89)
  const RESP_PCT = { 0:100.0, 1:100.0, 2:94.444444, 3:77.777778, 4:100.0, 5:83.333333, 6:66.666667, 7:50.0, 8:40.0 };
  const COUNTS   = { 0:6, 1:2, 2:18, 3:9, 4:13, 5:12, 6:12, 7:2, 8:15 };
  const RESPN    = { 0:6, 1:2, 2:17, 3:7, 4:13, 5:10, 6:8, 7:1, 8:6 };
  const NRESPN   = { 0:0, 1:0, 2:1, 3:2, 4:0, 5:2, 6:4, 7:1, 8:9 };
  const OR_VS0   = { 0:1.0, 1:0.3846153846, 2:0.8974358974, 3:0.2307692308, 4:2.0769230769, 5:0.3230769231, 6:0.1452991453, 7:0.0769230769, 8:0.0526315789 };

  // === UI state ===
  const state = { TSHRab: 0, TSI: 0, CAS: 0, EXO: 0 };

  // Handle toggles
  document.querySelectorAll(".toggle").forEach(group => {
    const field = group.getAttribute("data-field");
    const [btnNo, btnYes] = group.querySelectorAll("button");

    function setActive(val){
      state[field] = val;
      btnNo.classList.toggle("active", val === 0);
      btnNo.classList.toggle("no", true);
      btnYes.classList.toggle("active", val === 1);
      btnYes.classList.toggle("yes", true);
    }
    // default = No
    setActive(0);

    btnNo.addEventListener("click", ()=> setActive(0));
    btnYes.addEventListener("click", ()=> setActive(1));
  });

  // Risk + probability helpers
  function updateRisk(score){
    const pill = document.getElementById("riskPill");
    const details = document.getElementById("riskDetails");

    let label = "";
    let rangeText = "";
    let cls = "";

    if(score <= 4){
      label = "Low risk";
      rangeText = " (PREST 0–4)";
      cls = "low";
      details.innerHTML = `
        <li>Non-response rate: &lt;10%</li>
        <li>Standard IVMP protocol</li>
        <li>Routine monitoring</li>
      `;
    } else if(score <= 6){
      label = "Intermediate risk";
      rangeText = " (PREST 5–6)";
      cls = "intermediate";
      details.innerHTML = `
        <li>Non-response rate: 25–35%</li>
        <li>IVMP with close monitoring</li>
        <li>Early assessment at 4 weeks</li>
      `;
    } else{
      label = "High risk";
      rangeText = " (PREST ≥7)";
      cls = "high";
      details.innerHTML = `
        <li>Non-response rate: &gt;55%</li>
        <li>Consider alternative therapy</li>
        <li>Radiotherapy, biologics, or combination</li>
      `;
    }

    pill.textContent = label + rangeText;
    pill.classList.remove("low","intermediate","high");
    pill.classList.add(cls);
  }

  function updateProbability(score){
    const el = document.getElementById("nonRespProb");
    const logit = -2.86 + 0.51 * score;
    const p = 1 / (1 + Math.exp(-logit));
    const pct = (p * 100).toFixed(1);
    el.textContent = `${pct}%`;
  }

  // Calculate PREST
  function calcPrest(){
    const score =
      state.TSHRab*WEIGHTS.TSHRab +
      state.TSI*WEIGHTS.TSI +
      state.CAS*WEIGHTS.CAS +
      state.EXO*WEIGHTS.EXO;

    document.getElementById("prestScore").textContent = String(score);
    updateRisk(score);
    updateProbability(score);
    highlightRow(score);
    highlightBar(score);
  }
  document.getElementById("calcBtn").addEventListener("click", calcPrest);

  // Fill OR table
  function buildTable(){
    const tbody = document.querySelector("#orTable tbody");
    tbody.innerHTML = "";
    const scores = Object.keys(COUNTS).map(x=>parseInt(x)).sort((a,b)=>a-b);
    for(const s of scores){
      const tr = document.createElement("tr");
      tr.setAttribute("data-score-row", s);

      const td0 = document.createElement("td"); td0.textContent = s; tr.appendChild(td0);
      const td1 = document.createElement("td"); td1.textContent = COUNTS[s]; tr.appendChild(td1);
      const td2 = document.createElement("td"); td2.textContent = RESPN[s]; tr.appendChild(td2);
      const td3 = document.createElement("td"); td3.textContent = NRESPN[s]; tr.appendChild(td3);
      const td4 = document.createElement("td"); td4.textContent = (RESP_PCT[s]).toFixed(2); tr.appendChild(td4);
      const td5 = document.createElement("td"); td5.textContent = (OR_VS0[s]).toFixed(3); tr.appendChild(td5);

      tbody.appendChild(tr);
    }
  }
  buildTable();

  function highlightRow(score){
    document.querySelectorAll("#orTable tbody tr").forEach(tr=>{
      tr.style.background="transparent";
      tr.style.outline="none";
    });
    const row = document.querySelector(`#orTable tbody tr[data-score-row='${score}']`);
    if(row){
      row.style.background="#f7fbff";
      row.style.outline="2px solid #d0e6ff";
    }
  }

  // ===== Chart.js version (bar chart) =====
  let chart; // global ref for updates

  function buildChart(){
    const canvas = document.getElementById("chart");
    const ctx = canvas.getContext("2d");

    // Gradient fill (left→right)
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
    gradient.addColorStop(0, 'rgba(47, 111, 237, 0.85)');
    gradient.addColorStop(1, 'rgba(165, 196, 255, 0.85)');

    const labels = Object.keys(RESP_PCT).map(k=>String(k)).sort((a,b)=>Number(a)-Number(b));
    const data = labels.map(l => RESP_PCT[Number(l)]);

    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Responsiveness (%)',
          data,
          backgroundColor: labels.map(()=>gradient),
          borderColor: labels.map(()=> 'rgba(47, 111, 237, 1)'),
          borderWidth: labels.map(()=> 1),
          hoverBorderWidth: 2
        }]
      },
      options: {
        maintainAspectRatio: false,
        layout: { padding: 0 },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage' },
            ticks: { callback: (v)=> v + '%' }
          },
          x: { title: { display: true, text: 'PREST Score' } }
        },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context){
                const value = context.raw;
                const lower = value > 90 ? 90 : Math.floor(value/10)*10;
                const upper = value > 90 ? 100 : lower + 10;
                return ` Responsiveness: ${lower}-${upper}%`;
              }
            }
          },
          title: {
            display: true,
            text: 'Score–responsiveness plot (observed % responders by PREST score)'
          }
        },
        animation: { duration: 300 }
      }
    });
  }

  function highlightBar(score){
    if(!chart) return;
    const idx = chart.data.labels.findIndex(l => Number(l) === Number(score));
    const ds = chart.data.datasets[0];

    // Reset all bars to thin border
    ds.borderWidth = ds.borderWidth.map(()=>1);
    ds.borderColor = ds.borderColor.map(()=> 'rgba(47,111,237,1)');

    // Emphasize selected bar
    if(idx >= 0){
      ds.borderWidth[idx] = 4;
      ds.borderColor[idx] = 'rgba(18,184,134,1)'; // accent-2 for highlight
    }
    chart.update();
  }

  // Build Chart.js once
  buildChart();

  // Initial calculation for default state (score 0)
  calcPrest();

  // Rebuild gradient on resize for crispness
  window.addEventListener("resize", ()=>{
    if(chart){
      chart.destroy();
      buildChart();
      const currentScore = Number(document.getElementById("prestScore").textContent || 0);
      highlightBar(currentScore);
    }
  });
</script>
</body>
</html>
